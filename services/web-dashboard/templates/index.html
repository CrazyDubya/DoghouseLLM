<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent City Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-item .label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .status-item .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric {
            padding: 10px;
            background: #f7f9fc;
            border-radius: 8px;
        }

        .metric .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric .value {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .nav-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .nav-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .disconnected {
            background: rgba(244, 67, 54, 0.3);
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
        }

        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f0f2f5;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .activity-time {
            color: #666;
            font-size: 0.85em;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span id="statusText">Connecting...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üèôÔ∏è Multi-Agent City</h1>
            <p>Real-time monitoring dashboard for autonomous agent simulation</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="label">Simulation Time</div>
                <div class="value" id="simTime">00:00</div>
            </div>
            <div class="status-item">
                <div class="label">Active Agents</div>
                <div class="value" id="activeAgents">0</div>
            </div>
            <div class="status-item">
                <div class="label">Total Transactions</div>
                <div class="value" id="totalTransactions">0</div>
            </div>
            <div class="status-item">
                <div class="label">Active Interactions</div>
                <div class="value" id="activeInteractions">0</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>üåç World State</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="label">Current Tick</div>
                        <div class="value" id="currentTick">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Time of Day</div>
                        <div class="value" id="timeOfDay">Morning</div>
                    </div>
                    <div class="metric">
                        <div class="label">Districts</div>
                        <div class="value" id="districtCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Events Today</div>
                        <div class="value" id="eventsToday">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üí∞ Economy</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="label">Total Supply</div>
                        <div class="value" id="totalSupply">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">GDP</div>
                        <div class="value" id="gdp">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Avg Balance</div>
                        <div class="value" id="avgBalance">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Gini Index</div>
                        <div class="value" id="giniIndex">0.00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üèõÔ∏è Governance</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="label">Active Proposals</div>
                        <div class="value" id="activeProposals">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Council Members</div>
                        <div class="value" id="councilMembers">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Total Proposals</div>
                        <div class="value" id="totalProposals">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Avg Reputation</div>
                        <div class="value" id="avgReputation">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ü§ù Interactions</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="label">Active</div>
                        <div class="value" id="activeInteractionCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Completed Today</div>
                        <div class="value" id="completedInteractions">0</div>
                    </div>
                    <div class="metric">
                        <div class="label">Avg Duration</div>
                        <div class="value" id="avgInteractionDuration">0s</div>
                    </div>
                    <div class="metric">
                        <div class="label">Agents Interacting</div>
                        <div class="value" id="agentsInteracting">0</div>
                    </div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <h2>üìä Activity Feed</h2>
                <div class="activity-feed" id="activityFeed">
                    <div class="activity-item">
                        <div>System starting up...</div>
                        <div class="activity-time">Just now</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <a href="/world" class="nav-button">üó∫Ô∏è World Map</a>
            <a href="/agents" class="nav-button">ü§ñ Agents</a>
            <a href="/economy" class="nav-button">üíµ Economy</a>
            <a href="/governance" class="nav-button">‚öñÔ∏è Governance</a>
            <a href="/interactions" class="nav-button">üí¨ Interactions</a>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;
        let activityFeed = [];
        const maxActivityItems = 10;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);

            ws.onopen = function(event) {
                console.log('Connected to dashboard');
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('statusText').textContent = 'üü¢ Connected';

                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };

            ws.onclose = function(event) {
                console.log('Disconnected from dashboard');
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('statusText').textContent = 'üî¥ Disconnected';

                // Try to reconnect
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function updateDashboard(data) {
            // Update world state
            if (data.world) {
                updateElement('currentTick', data.world.current_tick || 0);
                updateElement('simTime', formatSimTime(data.world.current_time));
                updateElement('timeOfDay', getTimeOfDay(data.world.current_time));
                updateElement('districtCount', data.world.districts?.length || 0);
            }

            // Update agents
            if (data.agents?.active) {
                updateElement('activeAgents', data.agents.active.length || 0);
            }

            // Update economy
            if (data.economy) {
                updateElement('totalSupply', formatCurrency(data.economy.total_supply || 0));
                updateElement('gdp', formatCurrency(data.economy.gdp || 0));
                updateElement('avgBalance', formatCurrency(data.economy.average_balance || 0));
                updateElement('giniIndex', (data.economy.gini_coefficient || 0).toFixed(2));
                updateElement('totalTransactions', data.economy.total_transactions || 0);
            }

            // Update governance
            if (data.governance) {
                updateElement('activeProposals', data.governance.active_proposals || 0);
                updateElement('councilMembers', data.governance.council_members || 0);
                updateElement('totalProposals', data.governance.total_proposals || 0);
                updateElement('avgReputation', Math.round(data.governance.average_reputation || 0));
            }

            // Update interactions
            if (data.interactions) {
                updateElement('activeInteractionCount', data.interactions.total_active_interactions || 0);
                updateElement('activeInteractions', data.interactions.total_active_interactions || 0);
                updateElement('completedInteractions', data.interactions.total_completed_interactions || 0);
                updateElement('avgInteractionDuration',
                    Math.round(data.interactions.average_interaction_duration_seconds || 0) + 's');
                updateElement('agentsInteracting', data.interactions.agents_in_interactions || 0);
            }

            // Add activity to feed
            if (data.timestamp) {
                addActivity(generateActivityMessage(data));
            }
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                element.classList.add('updating');
                setTimeout(() => element.classList.remove('updating'), 300);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatSimTime(time) {
            if (!time) return '00:00';
            const date = new Date(time);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function getTimeOfDay(time) {
            if (!time) return 'Morning';
            const hour = new Date(time).getHours();
            if (hour < 6) return 'Night';
            if (hour < 12) return 'Morning';
            if (hour < 18) return 'Afternoon';
            if (hour < 21) return 'Evening';
            return 'Night';
        }

        function generateActivityMessage(data) {
            const messages = [];

            if (data.world?.current_tick % 10 === 0) {
                messages.push(`Simulation reached tick ${data.world.current_tick}`);
            }

            if (data.governance?.proposals?.length > 0) {
                const activeCount = data.governance.proposals.filter(p => p.status === 'active').length;
                if (activeCount > 0) {
                    messages.push(`${activeCount} proposal(s) open for voting`);
                }
            }

            if (data.economy?.total_transactions > 0 && Math.random() < 0.3) {
                messages.push(`Economic activity: ${data.economy.total_transactions} transactions`);
            }

            if (data.interactions?.total_active_interactions > 0 && Math.random() < 0.3) {
                messages.push(`${data.interactions.total_active_interactions} agents are interacting`);
            }

            return messages.length > 0 ? messages[Math.floor(Math.random() * messages.length)] : null;
        }

        function addActivity(message) {
            if (!message) return;

            const feedElement = document.getElementById('activityFeed');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <div>${message}</div>
                <div class="activity-time">${new Date().toLocaleTimeString()}</div>
            `;

            feedElement.insertBefore(activityItem, feedElement.firstChild);

            // Keep only the latest activities
            while (feedElement.children.length > maxActivityItems) {
                feedElement.removeChild(feedElement.lastChild);
            }
        }

        // Connect when page loads
        connectWebSocket();
    </script>
</body>
</html>